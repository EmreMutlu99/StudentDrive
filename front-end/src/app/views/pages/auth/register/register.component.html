<div class="container py-4" [formGroup]="form">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <a routerLink="/" class="nobleui-logo fw-bold text-decoration-none">
      Student<span>Drive</span>
    </a>
    <a routerLink="/auth/login" class="btn btn-outline-secondary">Log in</a>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-4 p-md-5">
      <!-- Progress -->
      <div class="progress mb-3" style="height: 6px">
        <div
          class="progress-bar bg-primary"
          role="progressbar"
          [style.width.%]="progressPct"
          [attr.aria-valuenow]="progressPct"
          aria-valuemin="0"
          aria-valuemax="100"
          style="transition: width 0.35s ease"
        ></div>
      </div>

      <!-- Stepper -->
      <div class="stepper mb-4 d-flex align-items-center gap-3">
        <!-- Step 1 -->
        <div class="step d-flex align-items-center gap-2" [class.active]="step >= 1">
          <div class="bubble">1</div>
          <div class="label">Account</div>
        </div>

        <!-- Connector 1→2 -->
        <div
          class="flex-grow-1"
          [style.height.px]="2"
          [style.background]="step >= 2 ? 'var(--bs-primary)' : 'var(--bs-border-color)'"
        ></div>

        <!-- Step 2 -->
        <div class="step d-flex align-items-center gap-2" [class.active]="step >= 2">
          <div class="bubble">2</div>
          <div class="label">Academic</div>
        </div>

        <!-- Connector 2→3 -->
        <div
          class="flex-grow-1"
          [style.height.px]="2"
          [style.background]="step >= 3 ? 'var(--bs-primary)' : 'var(--bs-border-color)'"
        ></div>

        <!-- Step 3 -->
        <div class="step d-flex align-items-center gap-2" [class.active]="step >= 3">
          <div class="bubble">3</div>
          <div class="label">Review</div>
        </div>
      </div>

      <div *ngIf="serverError" class="alert alert-danger">
        {{ serverError }}
      </div>

      <!-- Step 1 -->
      <form *ngIf="step === 1" [formGroup]="account" (ngSubmit)="next()">
        <div class="mb-3">
          <label class="form-label" for="username">Username</label>
          <input
            id="username"
            type="text"
            class="form-control"
            formControlName="username"
            placeholder="your.handle"
            autocomplete="username"
          />
          <div class="invalid-feedback d-block" *ngIf="username.touched && username.invalid">
            3–20 chars. Letters, numbers, ., _, -
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label" for="email">Email</label>
          <input
            id="email"
            type="email"
            class="form-control"
            formControlName="email"
            placeholder="you@uni.edu"
            autocomplete="email"
          />
          <div class="invalid-feedback d-block" *ngIf="email.touched && email.invalid">
            Please enter a valid email.
          </div>
        </div>

        <div class="mb-3" formGroupName="passwordGroup">
          <label class="form-label" for="password">Password</label>
          <input
            id="password"
            type="password"
            class="form-control"
            formControlName="password"
            placeholder="••••••••"
            autocomplete="new-password"
          />
          <div class="invalid-feedback d-block" *ngIf="password.touched && password.errors?.['minlength']">
            Minimum 6 characters.
          </div>

          <label class="form-label mt-3" for="confirm">Confirm password</label>
          <input
            id="confirm"
            type="password"
            class="form-control"
            formControlName="confirmPassword"
            placeholder="Repeat password"
            autocomplete="new-password"
          />
          <div class="invalid-feedback d-block" *ngIf="pwdGroup.touched && pwdGroup.errors?.['passwordMismatch']">
            Passwords do not match.
          </div>
        </div>

        <div class="d-flex justify-content-end">
          <button class="btn btn-primary" type="submit">Continue</button>
        </div>
      </form>

      <!-- Step 2 -->
      <form *ngIf="step === 2" [formGroup]="academic" (ngSubmit)="next()">
        <!-- University -->
        <div class="mb-3">
          <label class="form-label" for="university">University</label>
          <select id="university" class="form-select" formControlName="universityId">
            <option value="" disabled>Select your university</option>
            <option *ngFor="let u of universities" [value]="u.id">
              {{ u.name }}
            </option>
          </select>
          <div class="invalid-feedback d-block"
               *ngIf="academic.get('universityId')?.touched && academic.get('universityId')?.invalid">
            Please select your university.
          </div>
        </div>

        <!-- Degree Program -->
        <div class="mb-3">
          <label class="form-label" for="program">Degree program</label>
          <select
            id="program"
            class="form-select"
            formControlName="degreeProgramId"
            [disabled]="!programs.length">
            <option value="" disabled>Select your degree program</option>
            <option *ngFor="let p of programs" [value]="p.id">
              {{ p.name }} <ng-container *ngIf="p.degree">&nbsp;({{ p.degree }})</ng-container>
            </option>
          </select>

          <div class="invalid-feedback d-block"
               *ngIf="academic.get('degreeProgramId')?.touched && academic.get('degreeProgramId')?.invalid">
            Please select your degree program.
          </div>

          <div class="invalid-feedback d-block"
               *ngIf="academic.get('degreeProgramId')?.touched && academic.get('degreeProgramId')?.hasError('facultyMismatch')">
            Selected degree program doesn’t belong to the chosen university.
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Semester</label>
            <select class="form-select" formControlName="semesterType">
              <option value="WS">Winter (WS)</option>
              <option value="SS">Summer (SS)</option>
            </select>
          </div>
          <div class="col-md-8">
            <label class="form-label">Start year</label>
            <input type="number" class="form-control" formControlName="startYear" />
          </div>
        </div>

        <div class="d-flex justify-content-between mt-4">
          <button class="btn btn-light" type="button" (click)="back()">Back</button>
          <button class="btn btn-primary" type="submit">Continue</button>
        </div>
      </form>

      <!-- Step 3 -->
      <div *ngIf="step === 3" [formGroup]="profile">
        <div class="form-check mb-3">
          <input id="tos" type="checkbox" class="form-check-input" formControlName="acceptTos" />
          <label for="tos" class="form-check-label">
            I agree to the
            <a routerLink="/auth/legal/terms" target="_blank" rel="noopener">Terms of Service</a>
            and
            <a routerLink="/auth/legal/privacy" target="_blank" rel="noopener">Privacy Policy</a>.
          </label>
          <div class="invalid-feedback d-block"
               *ngIf="profile.get('acceptTos')?.touched && profile.get('acceptTos')?.invalid">
            You must accept to continue.
          </div>
        </div>

        <div class="border rounded p-3 mb-3 bg-body-tertiary">
          <h6 class="mb-2">Summary</h6>
          <ul class="m-0 small">
            <li><strong>Username:</strong> {{ account.get('username')?.value }}</li>
            <li><strong>Email:</strong> {{ account.get('email')?.value }}</li>
            <li><strong>University:</strong> {{ getUniversityName(academic.get('universityId')?.value) }}</li>
            <li><strong>Degree program:</strong> {{ getProgramName(academic.get('degreeProgramId')?.value) }}</li>
            <li>
              <strong>Start semester:</strong>
              {{ academic.get('semesterType')?.value }} {{ academic.get('startYear')?.value }}
            </li>
          </ul>
        </div>

        <div class="d-flex justify-content-between">
          <button class="btn btn-light" type="button" (click)="back()">Back</button>
          <button class="btn btn-primary" [disabled]="loading || profile.invalid" (click)="submit()">
            <span *ngIf="!loading">Create account</span>
            <span *ngIf="loading" class="spinner-border spinner-border-sm"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <p class="text-center text-muted small mt-3">
    Already have an account? <a routerLink="/auth/login">Log in</a>
  </p>
</div>
